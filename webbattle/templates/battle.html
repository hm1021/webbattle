{% extends "base.html" %}

{% block content %}

{% set lcount = 1 %}
{% set rcount = 1 %}

	<legend class="row">
		<div class="span12">
			<h1>Battle of {{ leftf }} vs {{ rightf }}</h1>
		</div>
	</legend>
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span6">
				<div id = "leftcomments">
					{% for c in lc %}
						<div class="row">
							<div class="span1">
								<a href="#" onclick="upvote_left('{{ c.comment }}','{{ c.author.email() }}','{{ c.when }}', 'lc_up{{ lcount }}')">
									<i class="icon-arrow-up"></i>
								</a>
								{% set votes = c.upvotes - c.downvotes %}
								<div id="lc_up{{ lcount }}">{{ votes }}</div>
								<a href="#" onclick="downvote_left('{{ c.comment }}','{{ c.author.email() }}','{{ c.when }}','lc_up{{ lcount }}')">
									<i class="icon-arrow-down"></i>
								</a>
							</div>
							<div class="span11">
								<blockquote id="left_comment">
									{{ c.comment }} 
									<small>
										by <cite title="name">{{ c.author.nickname() }}</cite>
									</small>
								</blockquote>
							</div>
						</div>
						{% set lcount = lcount + 1 %}
					{% endfor %}
				</div>
				<form method="post" accept-charset="utf-8">
					{{ left.csrf_token }}
					<p>
						<label for="left">Left Comment</label>
						{{ left.comment(id="leftbox")|safe }}
					</p>

					<input type="button" id="leftbutton" name="leftb" value="Comment on Left"/>
				</form>
			</div>

			<div class="span6">
				<div id = "rightcomments">
					{% for s in rc %}
						<div class="row-fluid">
							<div class="span1">
								<a href="#" onclick="upvote_right('{{ s.comment }}','{{ s.author.email() }}','{{ s.when }}', 'rc_up{{ rcount }}')">
									<i class="icon-arrow-up"></i>
								</a>
								{% set vote = s.upvotes - s.downvotes %}
								<div id="rc_up{{ rcount }}">{{ vote }}</div>
								<a href="#" onclick="downvote_right('{{ s.comment }}','{{ s.author.email() }}','{{ s.when }}','rc_up{{ rcount }}')">
									<i class="icon-arrow-down"></i>
								</a>
							</div>
							<div class="span11">
								<blockquote id="right_comment">
									{{ s.comment }} 
									<small>
										by <cite title="name">{{ s.author.nickname() }}</cite>
									</small>
								</blockquote>
							</div>
						</div>
						{% set rcount = rcount + 1 %}
					{% endfor %}
				</div>
				<form method="post" accept-charset="utf-8">
					{{ right.csrf_token }}
					<p>
						<label for="left">Right Comment</label>
						{{ right.comment(id="rightbox")|safe }}
					</p>

					<input type="button" id="rightbutton" name="rightb" value="Comment on Right"/>
				</form>
			</div>
		</div>
	</div>

<script>

	$("#leftbutton").click(function() {
		$.ajax({
			url: '/battle/{{ leftf }}/{{ rightf }}',
			data: { leftcomment : $("#leftbox").val() },
			type: "POST"
		}).success(function(data){
			new_comment_l = '<blockquote id="left_comment">' + data.lc + '<small> by <cite title="name">' + data.author +'</cite></small></blockquote>'
			$("#leftcomments").append(new_comment_l);
			$("#leftbox").val("");
			$("#rightbox").val("");
		})

	});


	$("#rightbutton").click(function() {
		$.ajax({
			url: '/battle/{{ leftf }}/{{ rightf }}',
			data: { rightcomment : $("#rightbox").val() },
			type: "POST"
		}).success(function(data){
			new_comment_r = '<blockquote id="right_comment">' + data.rc + '<small> by <cite title="name">' + data.author +'</cite></small></blockquote>'
			$("#rightcomments").append(new_comment_r);
			$("#leftbox").val("");
			$("#rightbox").val("");
		})
	});

	function upvote_left(comment,author,when,count){
		$.ajax({
			url: '/battle/upvote/{{ leftf }}/{{ rightf }}',
			data: { side : "left", comment : comment, author : author, when : when },
			type: "POST"
		}).success(function(data) {
			$("#"+count).html(data.votes)
		})
	}

	function upvote_right(comment,author,when,count){
		$.ajax({
			url: '/battle/upvote/{{ leftf }}/{{ rightf }}',
			data: { side : "right", comment : comment, author : author, when : when },
			type: "POST"
		}).success(function(data) {
			$("#"+count).html(data.votes)
		})
	}

	function downvote_left(comment,author,when,count){
		$.ajax({
			url: '/battle/downvote/{{ leftf }}/{{ rightf }}',
			data: { side : "left", comment : comment, author : author, when : when },
			type: "POST"
		}).success(function(data) {
			$("#"+count).html(data.votes)
		})
	}

	function downvote_right(comment,author,when,count){
		$.ajax({
			url: '/battle/downvote/{{ leftf }}/{{ rightf }}',
			data: { side : "right", comment : comment, author : author, when : when },
			type: "POST"
		}).success(function(data) {
			$("#"+count).html(data.votes)
		})
	}

</script>
{% endblock %}